#!/bin/bash
#SBATCH -J YourTeamName_SelfTest    # ä½œä¸šåç§°ï¼Œå¯ä»¥ä¿®æ”¹ä¸ºè‡ªå·±çš„é˜Ÿå
#SBATCH --ntasks-per-node=1         # æ¯ä¸ªèŠ‚ç‚¹è¿è¡Œ 1 ä¸ªä»»åŠ¡
#SBATCH --cpus-per-task=8           # æ¯ä¸ªä»»åŠ¡ä½¿ç”¨ 8 ä¸ª CPUæ ¸å¿ƒ
#SBATCH --gres=gpu:1                # ç”³è¯· 1 å¼  GPU å¡
#SBATCH -o output_%j.log            # å°†æ—¥å¿—è¾“å‡ºåˆ° output_<job_id>.log æ–‡ä»¶
#SBATCH --mem=32G

# --- Script Configuration ---
# C++ ç¼–è¯‘å™¨åŠå‚æ•°
COMPILER="hipcc"
CXX_FLAGS=" "

# GPUç‰ˆæœ¬æºæ–‡ä»¶å’Œå¯æ‰§è¡Œæ–‡ä»¶å
GPU_SOURCE_FILES="main.cpp kernel.hip" # å¦‚æœæœ‰å¤šä¸ª.cppæ–‡ä»¶ï¼Œç”¨ç©ºæ ¼éš”å¼€
GPU_EXECUTABLE="softmax"

# ä¸²è¡Œç‰ˆæœ¬æºæ–‡ä»¶å’Œå¯æ‰§è¡Œæ–‡ä»¶å
SERIAL_SOURCE_FILES="main_serial.cpp"
SERIAL_EXECUTABLE="softmax_serial"
SERIAL_COMPILER="g++"

# æµ‹è¯•ç”¨ä¾‹å’Œè¾“å‡ºç»“æœçš„ç›®å½•
TEST_CASE_DIR="testcases"
GOLDEN_DIR="testcases"
GPU_OUTPUT_DIR="my_outputs_gpu" # å­˜æ”¾GPUç¨‹åºè¾“å‡ºçš„ä¸´æ—¶ç›®å½•
SERIAL_OUTPUT_DIR="my_outputs_serial" # å­˜æ”¾ä¸²è¡Œç¨‹åºè¾“å‡ºçš„ä¸´æ—¶ç›®å½•

# æ­£ç¡®æ€§éªŒè¯è„šæœ¬
VERIFIER="verify.py"

# --- Script Body ---

# é‡åˆ°ä»»ä½•é”™è¯¯ç«‹å³é€€å‡º
set -e

# 1. å‡†å¤‡å·¥ä½œ
echo "================================================="
echo "           CCF TCARCH Performance Test           "
echo "================================================="
echo "Job started on $(hostname) at $(date)"
echo ""

# æ¸…ç†æ—§çš„è¾“å‡ºå’Œå¯æ‰§è¡Œæ–‡ä»¶
rm -f ${GPU_EXECUTABLE} ${SERIAL_EXECUTABLE}
rm -rf ${GPU_OUTPUT_DIR} ${SERIAL_OUTPUT_DIR}
mkdir -p ${GPU_OUTPUT_DIR} ${SERIAL_OUTPUT_DIR}

# 2. ç¼–è¯‘ä»£ç 
echo "STEP 1: Compiling source code..."

echo "  Compiling GPU version..."
${COMPILER} ${CXX_FLAGS} -o ${GPU_EXECUTABLE} ${GPU_SOURCE_FILES}

# æ£€æŸ¥GPUç‰ˆæœ¬ç¼–è¯‘æ˜¯å¦æˆåŠŸ
if [ ! -f ./${GPU_EXECUTABLE} ]; then
    echo "GPU COMPILATION FAILED! Please check your code."
    exit 1
fi
echo "  GPU compilation successful. Executable '${GPU_EXECUTABLE}' created."

echo "  Compiling Serial version..."
${SERIAL_COMPILER} ${CXX_FLAGS} -O2 -ffast-math -o ${SERIAL_EXECUTABLE} ${SERIAL_SOURCE_FILES} -lm

# æ£€æŸ¥ä¸²è¡Œç‰ˆæœ¬ç¼–è¯‘æ˜¯å¦æˆåŠŸ
if [ ! -f ./${SERIAL_EXECUTABLE} ]; then
    echo "SERIAL COMPILATION FAILED! Please check your code."
    exit 1
fi
echo "  Serial compilation successful. Executable '${SERIAL_EXECUTABLE}' created."
echo ""

# 3. åˆå§‹åŒ–è®¡æ—¶å™¨å’Œè®¡æ•°å™¨
GPU_TOTAL_TIME=0.0
SERIAL_TOTAL_TIME=0.0
PASSED_COUNT=0
TEST_COUNT=$(ls -1q ${TEST_CASE_DIR}/*.in | wc -l)

echo "STEP 2: Running test cases and performance comparison..."
echo "Found ${TEST_COUNT} test cases in ${TEST_CASE_DIR}"
echo "-------------------------------------------------"
printf "%-10s %-12s %-12s %-10s %-15s\n" "Test Case" "GPU Time(s)" "Serial Time(s)" "Speedup" "Status"
echo "-------------------------------------------------"

# 4. å¾ªç¯æ‰§è¡Œæ‰€æœ‰æµ‹è¯•ç”¨ä¾‹
for input_file in ${TEST_CASE_DIR}/*.in; do
    # ä»è¾“å…¥æ–‡ä»¶åæ´¾ç”Ÿå‡ºåŸºç¡€åå’Œå¯¹åº”çš„è¾“å‡ºæ–‡ä»¶å
    base_name=$(basename "${input_file}" .in)
    golden_output_file="${GOLDEN_DIR}/${base_name}.out"
    gpu_output_file="${GPU_OUTPUT_DIR}/${base_name}.gpu.out"
    serial_output_file="${SERIAL_OUTPUT_DIR}/${base_name}.serial.out"

    # æ£€æŸ¥æ ‡å‡†ç­”æ¡ˆæ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if [ ! -f "${golden_output_file}" ]; then
        printf "%-10s %-12s %-12s %-10s %-15s\n" "${base_name}" "SKIPPED" "SKIPPED" "N/A" "No Golden File"
        continue
    fi
    
    # è¿è¡ŒGPUç‰ˆæœ¬å¹¶è®¡æ—¶
    GPU_TIME=$( { /usr/bin/time -f "%e" ./${GPU_EXECUTABLE} "${input_file}" > "${gpu_output_file}"; } 2>&1 )
    
    # è¿è¡Œä¸²è¡Œç‰ˆæœ¬å¹¶è®¡æ—¶
    SERIAL_TIME=$( { /usr/bin/time -f "%e" ./${SERIAL_EXECUTABLE} "${input_file}" > "${serial_output_file}"; } 2>&1 )
    
    # éªŒè¯GPUç‰ˆæœ¬è¾“å‡ºçš„æ­£ç¡®æ€§
    GPU_CORRECT=false
    if python3 ${VERIFIER} "${gpu_output_file}" "${golden_output_file}" >/dev/null 2>&1; then
        GPU_CORRECT=true
    fi
    
    # éªŒè¯ä¸²è¡Œç‰ˆæœ¬è¾“å‡ºçš„æ­£ç¡®æ€§
    SERIAL_CORRECT=false
    if python3 ${VERIFIER} "${serial_output_file}" "${golden_output_file}" >/dev/null 2>&1; then
        SERIAL_CORRECT=true
    fi
    
    # è®¡ç®—åŠ é€Ÿæ¯”
    if [ "${SERIAL_TIME}" != "0.00" ] && [ "${GPU_TIME}" != "0.00" ]; then
        SPEEDUP=$(echo "scale=2; ${SERIAL_TIME} / ${GPU_TIME}" | bc)
    else
        SPEEDUP="N/A"
    fi
    
    # åˆ¤æ–­æ•´ä½“çŠ¶æ€
    if [ "$GPU_CORRECT" = true ] && [ "$SERIAL_CORRECT" = true ]; then
        STATUS="PASS"
        PASSED_COUNT=$((PASSED_COUNT + 1))
        # ç´¯åŠ æ—¶é—´
        GPU_TOTAL_TIME=$(echo "${GPU_TOTAL_TIME} + ${GPU_TIME}" | bc)
        SERIAL_TOTAL_TIME=$(echo "${SERIAL_TOTAL_TIME} + ${SERIAL_TIME}" | bc)
    elif [ "$GPU_CORRECT" = false ] && [ "$SERIAL_CORRECT" = true ]; then
        STATUS="GPU FAIL"
    elif [ "$GPU_CORRECT" = true ] && [ "$SERIAL_CORRECT" = false ]; then
        STATUS="SERIAL FAIL"
    else
        STATUS="BOTH FAIL"
    fi
    
    # è¾“å‡ºç»“æœ
    printf "%-10s %-12s %-12s %-10s %-15s\n" "${base_name}" "${GPU_TIME}" "${SERIAL_TIME}" "${SPEEDUP}" "${STATUS}"
    
    # å¦‚æœGPUç‰ˆæœ¬å¤±è´¥åˆ™ç»ˆæ­¢æµ‹è¯•
    if [ "$GPU_CORRECT" = false ]; then
        echo "-------------------------------------------------"
        echo "ERROR: GPU output mismatch on test case [${base_name}]."
        echo "GPU output is in: ${gpu_output_file}"
        echo "The correct output is in: ${golden_output_file}"
        echo "You can use 'diff -u ${golden_output_file} ${gpu_output_file}' to see the difference."
        echo "Aborting tests."
        exit 1
    fi
done

# 5. è¾“å‡ºæœ€ç»ˆæ€»ç»“
echo "-------------------------------------------------"
echo "FINAL RESULT: ALL TESTS PASSED!"
echo ""
echo "    Passed cases: ${PASSED_COUNT} / ${TEST_COUNT}"
echo ""

# è®¡ç®—æ€»ä½“åŠ é€Ÿæ¯”
if [ "${SERIAL_TOTAL_TIME}" != "0.00" ] && [ "${GPU_TOTAL_TIME}" != "0.00" ]; then
    OVERALL_SPEEDUP=$(echo "scale=2; ${SERIAL_TOTAL_TIME} / ${GPU_TOTAL_TIME}" | bc)
else
    OVERALL_SPEEDUP="N/A"
fi

echo "PERFORMANCE SUMMARY:"
echo "    GPU total execution time:    ${GPU_TOTAL_TIME} seconds"
echo "    Serial total execution time: ${SERIAL_TOTAL_TIME} seconds"
echo "    Overall speedup:             ${OVERALL_SPEEDUP}x"
echo ""

# æ€§èƒ½åˆ†æ
if [ "${OVERALL_SPEEDUP}" != "N/A" ]; then
    SPEEDUP_COMPARISON=$(echo "${OVERALL_SPEEDUP} > 1.0" | bc)
    if [ "${SPEEDUP_COMPARISON}" -eq 1 ]; then
        echo "ğŸš€ GPU implementation is faster than serial implementation!"
        EFFICIENCY=$(echo "scale=1; ${OVERALL_SPEEDUP} * 100 / 1" | bc)
        echo "   Performance improvement: ${EFFICIENCY}% faster"
    else
        echo "âš ï¸  GPU implementation is slower than serial implementation."
        echo "   Consider optimizing memory access patterns or kernel design."
    fi
fi

echo ""
echo "Job finished at $(date)"
echo "================================================="
